<html>
<head>
    <title>CM20219 – Coursework 2 – WebGL Bonus task</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <style>
        body { margin: 0; overflow: hidden; }
        canvas { width: 100%; height: 100%; }
    </style>
</head>
<body>
   <!--Orbit controls weren't supported in the original--> 
    <script src="three.js"></script>
    <script src = "GLTFLoader.js"></script>
    <script src="dat.gui.min.js"></script>
    <script>
        "use strict"; // https://stackoverflow.com/q/1335851/72470

        var camera, scene,renderer,mesh,beachBall;
        const clock = new THREE.Clock();
        var mixer;
        var light,params,light2,light3;
        var walkingLeft = true, walkingRight,rotatedRight,rotatedLeft;
        var translateCounter = 1;
        var loaded = false,sound,goja;
        // Initialise the scene, and draw it for the first time.
        init();
        animate();

        // Scene initialisation. This function is only run once, at the very beginning.
        function init()
        {
            scene = new THREE.Scene();
            const loaderTex = new THREE.TextureLoader();
            const bgTexture = loaderTex.load('background.jpg');
            scene.background = bgTexture;

            //create plane and resize
        //     var geometry = new THREE.PlaneGeometry(10,10);
        //     var material = new THREE.MeshPhongMaterial(
        //     {color:"grey", side: THREE.DoubleSide} );
        //     var plane = new THREE.Mesh( geometry, material );
        //     scene.add( plane );
        //    //translate,rotate until in a good position
        //     plane.rotation.x = 90 * Math.PI / 180;	// add this
        //     plane.position.y = -20;
        //     plane.translateX(-3);

            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(50,0,0);
            camera.lookAt(new THREE.Vector3(10, 0, 0));
            //Loader with my mesh and animations already created with blender via rigging.
            var loader = new THREE.GLTFLoader();
            loader.load(
                'Basemesh.glb',
                function ( gltf ) {
                mesh = gltf.scene.children[0];
                mesh.material = new THREE.MeshLambertMaterial();
                //translate and scale mesh
                mesh.scale.set(4,4,4);
                mesh.translateY(-10);
                //access my specific animation
                const animation = gltf.animations[2];
                mixer = new THREE.AnimationMixer(mesh);
                const action = mixer.clipAction(animation);
                //play my animation
                action.play();
                //add to the scene
                scene.add(mesh);
            }
            );

            var geometry   = new THREE.SphereGeometry(0.5, 32, 32)
            var material  = new THREE.MeshPhongMaterial()
            beachBall = new THREE.Mesh(geometry, material);
            material.map = THREE.ImageUtils.loadTexture('textures/BeachBallColor.jpg');
            scene.add(beachBall);
            beachBall.scale.set(4,4,4);
            beachBall.position.y = -17;
            beachBall.position.x = -22;

            light = new THREE.DirectionalLight(0xffffff);
            light.position.set(20,100,0);
            light.lookAt(0,-5,0);
            scene.add(light);

            light2 = new THREE.DirectionalLight(0xffffff);
            light2.position.set(50,200,-50);
            light2.lookAt(0,-10,0);
            scene.add(light2);

            light3 = new THREE.DirectionalLight(0xffffff);
            light3.position.set(50,400,30);
            light3.lookAt(0,-10,0);
            scene.add(light3);

            //Basic ambient lighting.
            scene.add(new THREE.AmbientLight(0xffffff,0.5));

            // Set up the Web GL renderer.
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true});
            renderer.setPixelRatio(window.devicePixelRatio); // HiDPI/retina rendering
            renderer.setSize(window.innerWidth, window.innerHeight);
            // controls = new THREE.OrbitControls( camera, renderer.domElement );
            document.body.appendChild(renderer.domElement);
            params = {intensity: 1,
                    pause: false,
                    startMusic: false
            };	
            //set up GUI
            var gui = new dat.GUI();
            gui.add( params, 'intensity', 0, 2 );
            gui.add( params, 'pause');
            gui.add(params,'startMusic').onChange(function(value){
                music();
            });
            gui.open();

            // Handle resizing of the browser window.
            window.addEventListener('resize', handleResize, false);
        }

        // Handle resizing of the browser window.
        function handleResize()
        {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function music(){
            if(params.startMusic&&!loaded){
                 //Add sounds to the scene
                 var listener = new THREE.AudioListener();
                camera.add(listener);
                sound = new THREE.Audio(listener);
                var audioLoader = new THREE.AudioLoader();
                audioLoader.load("waves.wav",function(buffer){
                sound.setBuffer(buffer);
                sound.setLoop(true);
                sound.setVolume(0.5);
                sound.play();
            });
            loaded = true;
            goja = true;
            }

            else if(params.startMusic&&!goja&&loaded){
                sound.play();
                goja = true
            }

            else if(!params.startMusic&&loaded&&goja){
                sound.pause();
                goja = false;
            }

        }

        // Animation loop function. This function is called whenever an update is required.
         function animate() {
            requestAnimationFrame( animate );
            //gui control for pausing my animation
            if(params.pause){
                return;
            }

            //gui for changing light intensity
            light.intensity = light2 = light3 =params.intensity;
            //updating animation of mesh with rig
            if(mixer!=null){
                mixer.update(clock.getDelta());
                if(mesh.position.z>47){
                    walkingLeft = false;
                    walkingRight = true;
                    mesh.rotateY (-Math.PI);
                    rotatedRight = true;
                    rotatedLeft = false;
                }
                if(mesh.position.z<-47){
                   walkingLeft = true;
                   walkingRight = false;
                   mesh.rotateY (Math.PI);
                   rotatedLeft = true;
                   rotatedRight = false;

                }

                if(walkingLeft&&!rotatedLeft){
                    mesh.translateZ(0.1);
                }

                if(walkingLeft&&rotatedLeft){
                    mesh.translateZ(0.1);
                }
                if(walkingRight&&rotatedRight){
                    mesh.translateZ(0.1);
                }
            }

            if(translateCounter==100){
                translateCounter = -100;
            }

            if(translateCounter==0){
                translateCounter = 1;
            }

            if(translateCounter<0){
                beachBall.translateY(0.005);
                translateCounter++;
            }

            else{
                beachBall.translateY(-0.005);
                translateCounter++;
            }
            renderer.render(scene, camera);
        };
    </script>
</body>
</html>
